<!DOCTYPE html>
<html>
    <head>
        <title>Kequtwitch</title>
        <link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" />
        <link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.18.1/build/cssreset-context/cssreset-context-min.css" />
        <link rel="stylesheet" type="text/css" href="/assets/css/hljs.css" />
        <link rel="stylesheet" type="text/css" href="/assets/css/markdown.css" />
        <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />
    </head>
    <body>
        <div id="header">
            <a href="/" class="badge" title="Npmjs.com"><img src="/assets/images/npmjs.png" alt="Npmjs" /></a>
            <a href="https://github.com/Kequc/kequtwitch" class="badge" title="Github.com"><img src="/assets/images/github.png" alt="Github" /></a>
            <a href="/" class="home"><em>Kequ</em><strong>twitch</strong> <span class="headline">is a twitch library</span></a>
        </div>
        <div id="container">
            <div id="sidebar">
                <ul class="list">
                    <li>
                        <h4><a href="">IRC</a></h4>
                        <ul>
                            <li><a href="/pages/irc-examples.html">IRC examples</a></li>
                            <li><a href="">Item</a></li>
                            <li><a href="">Item</a></li>
                            <li><a href="">Item</a></li>
                            <li><a href="">Item</a></li>
                            <li><a href="">Item</a></li>
                            <li><a href="">Item</a></li>
                        </ul>
                    </li>
                </ul>
            </div>

<div id="content">
<h1>IRC examples</h1>
<p>This guide is here to give you a few code snippets to work with. Many demonstrate how you would mimic behaviour found in more user-friendly libraries like <a href="http://www.tmijs.org/">tmi.js</a>.</p>
<hr />
<h2>Say</h2>
<p>The <a href="https://dev.twitch.tv/docs/irc/chat-rooms/#privmsg-twitch-chat-rooms">PRIVMSG</a> Twitch command is used to send and receive chat instructions. If we wanted to send the message <code>&quot;Hi everyone!&quot;</code> to the channel <code>#mrkequc</code> our IRC message would look like the following.</p>
<pre><code>PRIVMSG #mrkequc :Hi everyone!
</code></pre>
<p>If this is something you're going to be doing you could add an extension to make the interaction easier.</p>
<pre><code class="language-javascript">twitch.irc.say = <span class="hljs-function">(<span class="hljs-params">channel, message</span>) =&gt;</span> {
    twitch.irc.send(<span class="hljs-string">`PRIVMSG <span class="hljs-subst">${channel}</span> :<span class="hljs-subst">${message}</span>`</span>);
};

twitch.irc.say(<span class="hljs-string">'#mrkequc'</span>, <span class="hljs-string">'Hi everyone!'</span>);
</code></pre>
<hr />
<h2>Learn about the msg object</h2>
<p>A <code>msg</code> object represents a line of text delivered from the connected Twitch server.</p>
<p>It contains information in a hopefully convenient format for you to make use of, in whatever way that may be. Many are easy to understand and consistent such as the <a href="https://dev.twitch.tv/docs/irc/chat-rooms/#join-twitch-chat-rooms">JOIN</a> Twitch command, however some can also be a little unusual. This library lets you do anything you want with all available message information. Examples of what raw messages look like can be found on the <a href="https://dev.twitch.tv/docs/irc/guide/">Twitch IRC guide</a>.</p>
<table>
<thead>
<tr>
<th>param</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>raw</code></td>
<td>The full message in raw form</td>
</tr>
<tr>
<td><code>tags</code></td>
<td>Object containing all tags</td>
</tr>
<tr>
<td><code>prefix</code></td>
<td>Object containing prefix information</td>
</tr>
<tr>
<td><code>prefix.full</code></td>
<td>Full prefix (Ie. <code>'mrkequc!mrkequc@mrkequc.tmi.twitch.tv'</code>)</td>
</tr>
<tr>
<td><code>prefix.host</code></td>
<td>Host (Ie. <code>'mrkequc.tmi.twitch.tv'</code>)</td>
</tr>
<tr>
<td><code>prefix.user</code></td>
<td>User (Ie. <code>'mrkequc'</code>)</td>
</tr>
<tr>
<td><code>command</code></td>
<td>The Twitch command (Ie. <code>'PRIVMSG'</code>)</td>
</tr>
<tr>
<td><code>params</code></td>
<td>Array of parameters that follow the command (Ie. <code>['#mrkequc', 'Hi everyone!']</code>)</td>
</tr>
<tr>
<td><code>inferred</code></td>
<td>Object containing special inferred information (Ie. <code>{ viewers: 10 }</code>)</td>
</tr>
</tbody>
</table>
<hr />
<h2>Learn about inferences</h2>
<p>All <code>msg</code> objects have a <code>inferred</code> object.</p>
<p>It is up to you to populate it with any additional information you need out of messages by defining inferences. You can have one inference for every Twitch command, they are defined in the <code>Twitch</code> constructor or later on using the <code>infer</code> method. All inference methods are syncronous, can only be defined once, and should return an object.</p>
<p>A special parameter called <code>inferred.type</code>, if you wish to use it, will emit the message again using the name that you set.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> twitch = <span class="hljs-keyword">new</span> Twitch(<span class="hljs-string">'your-oauth-token'</span>);

twitch.irc.infer(<span class="hljs-string">'join'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inferJoin</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">const</span> userBackwards = msg.prefix.user.split(<span class="hljs-string">''</span>).reverse().join(<span class="hljs-string">''</span>);

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'socks'</span>,
        userBackwards
    };
});

twitch.irc.on(<span class="hljs-string">'twitch-join'</span>, (msg) =&gt; {
    <span class="hljs-built_in">console</span>.log(msg.inferred); <span class="hljs-comment">// { type: 'socks', userBackwards: 'cuqek' }</span>
});

twitch.irc.on(<span class="hljs-string">'socks'</span>, (msg) =&gt; {
    <span class="hljs-built_in">console</span>.log(msg.inferred); <span class="hljs-comment">// { type: 'socks', userBackwards: 'cuqek' }</span>
});
</code></pre>
<hr />
<h2>Chat</h2>
<p>A message someone else posted in chat looks more complicated. As stated this library parses the message for you, however you can extend the library to emit more familiar events with the following. Keeping in mind you can edit this however you want to suit your needs.</p>
<p>Granted the incredibly odd <code>'jtv'</code> 'hosting you' <code>PRIVMSG</code> Twitch command as seen below makes this all look very complicated, it is still in use by Twitch as of September 01, 2018. You could decide to ignore those messages it's entirely up to you.</p>
<p>The following example mimics behaviour found in the popular <a href="http://www.tmijs.org/">tmi.js</a> library.</p>
<pre><code class="language-javascript">twitch.irc.infer(<span class="hljs-string">'privmsg'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inferPrivmsg</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">if</span> (msg.prefix.user === <span class="hljs-string">'jtv'</span>) {
        <span class="hljs-comment">// "ronni is now hosting you for 0 viewers."</span>
        <span class="hljs-keyword">const</span> message = msg.params[<span class="hljs-number">0</span>];

        <span class="hljs-keyword">if</span> (!message.includes(<span class="hljs-string">'hosting you'</span>)) {
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">const</span> parts = message.split(<span class="hljs-string">' '</span>);
        <span class="hljs-keyword">const</span> user = parts.shift();
        <span class="hljs-keyword">const</span> viewers = parts.find(<span class="hljs-function"><span class="hljs-params">part</span> =&gt;</span> !<span class="hljs-built_in">isNaN</span>(part));
        <span class="hljs-keyword">const</span> autoHosting = parts.includes(<span class="hljs-string">'auto-hosting'</span>);

        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'hosted'</span>,
            user,
            <span class="hljs-attr">viewers</span>: <span class="hljs-built_in">parseInt</span>(viewers, <span class="hljs-number">10</span>) || <span class="hljs-number">0</span>,
            autoHosting
        };
    }

    <span class="hljs-keyword">if</span> (msg.params[<span class="hljs-number">1</span>].indexOf(<span class="hljs-string">'ACTION /'</span>) === <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// "ACTION /me is great!"</span>
        <span class="hljs-keyword">const</span> message = msg.params[<span class="hljs-number">1</span>].substring(<span class="hljs-number">7</span>);

        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'action'</span>
            message
        };
    }

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: (msg.tags.bits || <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'cheer'</span> : <span class="hljs-string">'chat'</span>
    };
});

twitch.irc.on(<span class="hljs-string">'hosted'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onHosted</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">const</span> { user, viewers } = msg.inferred;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${user}</span> is now hosting you for <span class="hljs-subst">${viewers}</span> viewers!`</span>);
});

twitch.irc.on(<span class="hljs-string">'action'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onAction</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">const</span> { displayName } = msg.tags;
    <span class="hljs-keyword">const</span> { message } = msg.inferred;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${displayName}</span> in <span class="hljs-subst">${channel}</span> actioned "<span class="hljs-subst">${message}</span>"!`</span>);
});

twitch.irc.on(<span class="hljs-string">'cheer'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onCheer</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">const</span> { displayName, bits } = msg.tags;
    <span class="hljs-keyword">const</span> [ channel, message ] = msg.params;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${displayName}</span> in <span class="hljs-subst">${channel}</span> cheered <span class="hljs-subst">${bits}</span> and said "<span class="hljs-subst">${message}</span>"!`</span>);
});

twitch.irc.on(<span class="hljs-string">'chat'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onChat</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">const</span> { displayName } = msg.tags;
    <span class="hljs-keyword">const</span> [ channel, message ] = msg.params;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${displayName}</span> in <span class="hljs-subst">${channel}</span> said "<span class="hljs-subst">${message}</span>"!`</span>);
});
</code></pre>
<hr />
<h2>Emotesets</h2>
<p>Emitting emotesets whenever they are updated can be a relatively simple thing to set up. We might use this if we were parsing messages to use emoticons and always want to keep them up to date.</p>
<p>Add an extension that watches for a change and fetches the new emotes.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">let</span> last;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkEmoteSets</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">const</span> emotesets = msg.tags.emoteSets;

    <span class="hljs-comment">// Look for new emotesets</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> emotesets !== <span class="hljs-string">'string'</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span> (last === emotesets) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// Emotesets have changed</span>
    last = emotesets;

    <span class="hljs-comment">// Fetch</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> twitch.api.request(<span class="hljs-string">'/chat/emoticon_images'</span>, {
        <span class="hljs-attr">data</span>: { emotesets },
        <span class="hljs-attr">kraken</span>: <span class="hljs-literal">true</span>
    });

    <span class="hljs-comment">// Emit result</span>
    twitch.irc.emit(<span class="hljs-string">'emotesets'</span>, result);
}

twitch.irc.on(<span class="hljs-string">'twitch-userstate'</span>, checkEmoteSets);
twitch.irc.on(<span class="hljs-string">'twitch-globaluserstate'</span>, checkEmoteSets);

twitch.irc.on(<span class="hljs-string">'emotesets'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onEmotesets</span> (<span class="hljs-params">emotesets</span>) </span>{
    <span class="hljs-comment">// Updated emotes arrived!</span>
});
</code></pre>
<hr />
<h2>Mod and unmod</h2>
<p>The <a href="https://dev.twitch.tv/docs/irc/commands/#clearchat-twitch-commands">MODE</a> Twitch command delivers a slightly cryptic payload. Twitch still uses these <code>'jtv'</code> events as of September 1, 2018. You may choose to extend the library separating this data into different events.</p>
<pre><code class="language-javascript">twitch.irc.infer(<span class="hljs-string">'mode'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inferMode</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">const</span> key = msg.params[<span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> types = { <span class="hljs-string">'+o'</span>: <span class="hljs-string">'mod'</span>, <span class="hljs-string">'-o'</span>: <span class="hljs-string">'unmod'</span> };

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: types[key]
    };
});

twitch.irc.on(<span class="hljs-string">'mod'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onMod</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">const</span> [ channel, , user ] = msg.params;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${user}</span> is now modding <span class="hljs-subst">${channel}</span>!`</span>);
});

twitch.irc.on(<span class="hljs-string">'unmod'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onUnmod</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">const</span> [ channel, , user ] = msg.params;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${user}</span> is no longer a mod on <span class="hljs-subst">${channel}</span>!`</span>);
});
</code></pre>
<hr />
<h2>Ban and timeout</h2>
<p>The <a href="https://dev.twitch.tv/docs/irc/commands/#clearchat-twitch-commands">CLEARCHAT</a> Twitch command often contains information about users being banned or given a timeout.</p>
<pre><code class="language-javascript">twitch.irc.infer(<span class="hljs-string">'clearchat'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inferClearchat</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">let</span> type;

    <span class="hljs-keyword">if</span> (msg.params.length &lt; <span class="hljs-number">2</span>) {
        type = <span class="hljs-string">'clearchat'</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (msg.tags.banDuration === <span class="hljs-literal">null</span>) {
        type = <span class="hljs-string">'ban'</span>;
    } <span class="hljs-keyword">else</span>  {
        type = <span class="hljs-string">'timeout'</span>;
    }

    <span class="hljs-keyword">return</span> { type };
});

twitch.irc.on(<span class="hljs-string">'clearchat'</span>, (msg) =&gt; {
    <span class="hljs-keyword">const</span> [ channel ] = msg.params;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Chat in <span class="hljs-subst">${channel}</span> has been cleared by a moderator!`</span>);
});

twitch.irc.on(<span class="hljs-string">'ban'</span>, (msg) =&gt; {
    <span class="hljs-keyword">const</span> [ channel, user ] = msg.params;
    <span class="hljs-keyword">const</span> { banReason } = msg.tags;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${user}</span> has been banned from <span class="hljs-subst">${channel}</span>. Reason: <span class="hljs-subst">${banReason}</span>`</span>);
});

twitch.irc.on(<span class="hljs-string">'timeout'</span>, (msg) =&gt; {
    <span class="hljs-keyword">const</span> [ channel, user ] = msg.params;
    <span class="hljs-keyword">const</span> { banReason, banDuration } = msg.tags;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${user}</span> has been given a timeout from <span class="hljs-subst">${channel}</span> for <span class="hljs-subst">${banDuration}</span> seconds. Reason: <span class="hljs-subst">${banReason}</span>`</span>);
});
</code></pre>
<hr />
<h2>Host and unhost</h2>
<p>The <a href="https://dev.twitch.tv/docs/irc/commands/#hosttarget-twitch-commands">HOSTTARGET</a> Twitch command includes differently formatted parameters depending on whether you start hosting a channel or stop hosting one. So it can be helpful to split this up into separate events.</p>
<pre><code class="language-javascript">twitch.irc.infer(<span class="hljs-string">'hosttarget'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">inferHosttarget</span> (<span class="hljs-params">msg</span>) </span>{
    <span class="hljs-keyword">let</span> type;
    <span class="hljs-keyword">let</span> viewers;

    <span class="hljs-keyword">if</span> (msg.params[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] === <span class="hljs-string">'-'</span>) {
        <span class="hljs-comment">// "- 10"</span>
        type = <span class="hljs-string">'unhost'</span>;
        viewers = msg.params[<span class="hljs-number">1</span>].replace(<span class="hljs-string">'- '</span>, <span class="hljs-string">''</span>);
    } <span class="hljs-keyword">else</span> {
        type = <span class="hljs-string">'host'</span>;
        viewers = msg.params[<span class="hljs-number">2</span>];
    }

    <span class="hljs-keyword">return</span> {
        type,
        <span class="hljs-attr">viewers</span>: <span class="hljs-built_in">parseInt</span>(viewers, <span class="hljs-number">10</span>) || <span class="hljs-number">0</span>;
    };
});

twitch.irc.on(<span class="hljs-string">'host'</span>, (msg) =&gt; {
    <span class="hljs-keyword">const</span> [ channel ] = msg.params;
    <span class="hljs-keyword">const</span> { viewers } = msg.inferred;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Hosting <span class="hljs-subst">${viewers}</span> viewers from <span class="hljs-subst">${channel}</span>!`</span>);
});

twitch.irc.on(<span class="hljs-string">'unhost'</span>, (msg) =&gt; {
    <span class="hljs-keyword">const</span> { viewers } = msg.inferred;
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Stopped hosting <span class="hljs-subst">${viewers}</span> viewers!`</span>);
});
</code></pre>

</div>

    </body>
</html>
